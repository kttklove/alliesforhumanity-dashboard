<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Business of Homelessness — Marion County</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<style>
:root { --bg:#fff; --text:#111; --muted:#555; --accent:#0e7c86; --card:#f7f7f9; --shadow:0 2px 10px rgba(0,0,0,.08); --radius:16px; }
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Noto Sans,sans-serif;line-height:1.45}
.wrap{max-width:1100px;margin:0 auto;padding:20px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
.span-12{grid-column:span 12}.span-8{grid-column:span 8}.span-6{grid-column:span 6}.span-4{grid-column:span 4}.span-3{grid-column:span 3}
@media (max-width:920px){.span-8,.span-6{grid-column:span 12}.span-4,.span-3{grid-column:span 6}}
@media (max-width:640px){.span-4,.span-3{grid-column:span 12}}
h1{margin:4px 0 0} h2{margin:0 0 10px} h3{margin:0 0 6px;color:var(--muted);font-size:15px}
.small{font-size:12px;color:var(--muted)} .row{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef8f9;border:1px solid #c8ecef;color:var(--accent);font-size:12px}
.pending{display:inline-block;padding:2px 8px;border-radius:999px;background:#fff8e1;color:#8a5a00;font-size:12px;border:1px solid #ffda6a}
.btnbar{display:flex;gap:6px;flex-wrap:wrap}
button.tab{background:#fff;border:1px solid #d8d8d8;border-radius:10px;padding:6px 10px;cursor:pointer;font-size:12px}
button.tab:hover{border-color:#bbb} button.tab.active{background:#eef8f9;border-color:#c8ecef;color:var(--accent)}
.kpi{font-size:28px;font-weight:600}
.divider{height:1px;background:#e8e8e8;margin:10px 0 12px}
label {font-size:13px;color:#333}
input[type=range]{width:100%}
</style>
</head>
<body>
<header class="wrap">
  <h1>Business of Homelessness – Marion County</h1>
  <p class="small">Crisis costs (ED, jail, shelter) vs solutions (RRH, PSH). Sources linked under each chart.</p>
</header>
<main class="wrap" id="app" aria-live="polite">
  <section class="grid">
    <div class="card span-8" id="shelter-costs-card">
      <h2>Cost per night of shelter (USD)</h2>
      <canvas id="chartShelterCosts"></canvas>
      <div id="shelterCostsPending" class="small"></div>
      <div class="small" id="shelterCostsSource"></div>
    </div>

    <div class="card span-4">
      <h2>Contracts and funding</h2>
      <div id="contractsStats" class="row"></div>
      <div class="divider"></div>
      <canvas id="chartContracts"></canvas>
      <div class="small" id="contractsSource"></div>
    </div>

    <div class="card span-12">
      <h2>Emergency department facility fee — typical moderate visit <span class="small">(CPT 99284)</span></h2>
      <div class="small">Click a hospital to view payer rates. “CPT 99284” = moderate complexity ED visit (treat-and-release).</div>
      <div class="btnbar" id="edTabs" role="tablist" aria-label="Hospital selector"></div>
      <canvas id="chartED"></canvas>
      <div class="small" id="edPending"></div>
      <div class="small" id="edSource"></div>
    </div>

    <div class="card span-12">
      <h2>Crisis costs vs Housing (per person, annual)</h2>
      <div class="grid">
        <div class="span-6">
          <label for="edVisits">ED treat-and-release visits per year</label>
          <input id="edVisits" type="range" min="0" max="24" step="1" value="6" />
          <div class="row"><div><span class="kpi" id="edVisitsCount">6</span> <span class="small">visits</span></div><div><span class="kpi" id="edTotal">$0</span> <span class="small">ED total</span></div></div>
        </div>
        <div class="span-6">
          <label for="jailNights">Nights in jail per year</label>
          <input id="jailNights" type="range" min="0" max="60" step="1" value="10" />
          <div class="row"><div><span class="kpi" id="jailNightsCount">10</span> <span class="small">nights</span></div><div><span class="kpi" id="jailTotal">$0</span> <span class="small">Jail total<span id="jailRangeNote" class="small"></span></span></div></div>
        </div>
      </div>
      <div class="divider"></div>
      <canvas id="chartCompare"></canvas>
      <div class="small" id="compareSource"></div>
    </div>

    <div class="card span-12">
      <h2>Findings from the literature</h2>
      <div id="findings"></div>
    </div>

    <div class="card span-12">
      <h2>Data status</h2>
      <div id="status"></div>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script>
function EP(p){ return new URL(p, window.location.href).toString(); }
var ENDPOINTS = {
  shelter_costs: EP("data/endpoints/v1/marion/shelter_costs.json"),
  shelter_contracts: EP("data/endpoints/v1/marion/shelter_contracts.json"),
  hospital_er: EP("data/endpoints/v1/marion/hospital_er_99284.json"),
  ref_costs: EP("data/endpoints/v1/reference/costs.json"),
  findings: EP("data/endpoints/v1/reference/findings.json")
};
function fmtUSD(n){ return (n==null) ? "—" : n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0}); }
function qs(sel){ return document.querySelector(sel); }
function loadJSON(path){
  return fetch(path,{cache:"no-store"}).then(function(r){
    if(!r.ok){ throw new Error("Failed to load "+path); }
    return r.json();
  });
}
function provenanceLinks(rows){
  var urls = [];
  for (var i=0;i<(rows||[]).length;i++){
    var r = rows[i]; if(!r) continue;
    var prov = r.provenance;
    if (Object.prototype.toString.call(prov) === "[object Array]"){
      for(var j=0;j<prov.length;j++){ var p = prov[j]; if(p && p.url && urls.indexOf(p.url)===-1){ urls.push(p.url); } }
    } else if (prov && prov.url){ if(urls.indexOf(prov.url)===-1){ urls.push(prov.url); } }
  }
  var s = "";
  for (var k=0;k<urls.length;k++){ s += '<a href="'+urls[k]+'" target="_blank" rel="noopener">source</a>'; if(k<urls.length-1) s += " · "; }
  return s;
}

function init(){
  Promise.all([
    loadJSON(ENDPOINTS.shelter_costs),
    loadJSON(ENDPOINTS.shelter_contracts),
    loadJSON(ENDPOINTS.hospital_er),
    loadJSON(ENDPOINTS.ref_costs),
    loadJSON(ENDPOINTS.findings)
  ]).then(function(all){
    var shelterCosts = all[0], contracts = all[1], ed = all[2], refs = all[3], finds = all[4];

    // Shelter per-diem
    var scRows = (shelterCosts && shelterCosts.data) ? shelterCosts.data : [];
    var scKnown = []; var scPending = [];
    for (var i=0;i<scRows.length;i++){
      var r = scRows[i];
      if (typeof r.value === "number") scKnown.push(r);
      if (r.pending || r.value == null) scPending.push(r);
    }
    var scCtx = qs("#chartShelterCosts");
    if (scKnown.length){
      var labels1 = []; var data1 = [];
      for (var i2=0;i2<scKnown.length;i2++){ labels1.push(scKnown[i2].provider); data1.push(scKnown[i2].value); }
      new Chart(scCtx, { type:"bar", data:{ labels: labels1, datasets:[{ label:"USD per person per night", data:data1 }]},
        options:{ plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:function(c){ return fmtUSD(c.parsed.y); } }}},
                  scales:{ y:{ beginAtZero:true, ticks:{ callback:function(v){ return fmtUSD(v); }}} } });
    } else { scCtx.parentNode.replaceChild(document.createTextNode("No published per-diem values yet."), scCtx); }
    if (scPending.length){
      var pend = ""; for (var p=0;p<scPending.length;p++){ pend += 'Pending: <span class="pill">'+scPending[p].provider+'</span> '; }
      qs("#shelterCostsPending").innerHTML = pend;
    }
    qs("#shelterCostsSource").innerHTML = provenanceLinks(scRows);

    // Contracts
    var cRows = (contracts && contracts.data) ? contracts.data : [];
    var cCtx = qs("#chartContracts");
    var labels2 = []; var amounts = [];
    for (var j2=0;j2<cRows.length;j2++){ labels2.push(cRows[j2].program); amounts.push(cRows[j2].amount_usd || 0); }
    new Chart(cCtx, { type:"bar", data:{ labels: labels2, datasets:[{ label:"Amount (USD)", data: amounts }]},
      options:{ indexAxis:"y", plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:function(c){ return fmtUSD(c.parsed.x); }}}},
                scales:{ x:{ ticks:{ callback:function(v){ return fmtUSD(v); }}} } });
    var total = 0; for (var t=0;t<amounts.length;t++){ total += amounts[t]; }
    qs("#contractsStats").innerHTML = '<div class="kpi">'+fmtUSD(total)+'</div><div class="small">Total funding in listed programs</div>';
    qs("#contractsSource").innerHTML = provenanceLinks(cRows);

    // ED by hospital
    var edRows = (ed && ed.data) ? ed.data : [];
    var hospitals = []; // unique labels
    for (var e=0;e<edRows.length;e++){
      var lab = (edRows[e].system||"") + " — " + (edRows[e].facility||"");
      if (hospitals.indexOf(lab) === -1){ hospitals.push(lab); }
    }
    var tabWrap = qs("#edTabs");
    var active = hospitals.length ? hospitals[0] : null;

    function renderED(){
      var el = qs("#chartED");
      var ctx = el.getContext("2d"); ctx.clearRect(0,0,el.width, el.height);
      var rows = []; for (var i3=0;i3<edRows.length;i3++){ var rr = edRows[i3]; if ((rr.system||"")+" — "+(rr.facility||"") === active){ rows.push(rr);} }
      var known = []; for (var k3=0;k3<rows.length;k3++){ if (typeof rows[k3].rate_usd === "number"){ known.push(rows[k3]); } }
      var payers = ["self_pay_cash","medicaid","commercial_example"];
      var lbls = ["self pay cash","medicaid","commercial example"];
      var data = []; for (var p2=0;p2<payers.length;p2++){ var found = null; for (var q=0;q<rows.length;q++){ if (rows[q].payer_type===payers[p2]){ found = rows[q]; break; } } data.push(found ? found.rate_usd : null); }
      if (known.length){
        new Chart(el, { type:"bar", data:{ labels: lbls, datasets:[{ label:"USD per visit", data:data }]},
          options:{ plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:function(c){ return fmtUSD(c.parsed.y); }}}},
                    scales:{ y:{ beginAtZero:true, ticks:{ callback:function(v){ return fmtUSD(v); }}}} });
        qs("#edPending").textContent = "";
      } else {
        new Chart(el, { type:"bar", data:{ labels:["No published local rates yet"], datasets:[{ data:[0] }]},
          options:{ plugins:{ legend:{display:false}, tooltip:{enabled:false}}, scales:{ y:{display:false}, x:{display:false}} });
        qs("#edPending").innerHTML = '<span class="pending">Local rate extraction pending</span> · Using national means below.';
      }
      qs("#edSource").innerHTML = provenanceLinks(rows);
    }
    if (hospitals.length){
      for (var h=0; h<hospitals.length; h++){
        (function(hname, first){
          var b = document.createElement("button");
          b.className = "tab" + (first ? " active" : "");
          b.setAttribute("role","tab"); b.setAttribute("aria-selected", first ? "true" : "false");
          b.textContent = hname;
          b.onclick = function(){
            var bs = tabWrap.querySelectorAll("button.tab");
            for (var k=0;k<bs.length;k++){ bs[k].classList.remove("active"); bs[k].setAttribute("aria-selected","false"); }
            b.classList.add("active"); b.setAttribute("aria-selected","true");
            active = hname; renderED();
          };
          tabWrap.appendChild(b);
        })(hospitals[h], h===0);
      }
    } else { tabWrap.innerHTML = '<span class="small">No hospitals found in dataset.</span>'; }
    renderED();

    // Crisis vs Housing comparator
    var refRows = (refs && refs.data) ? refs.data : [];
    function findVal(cat){ for (var i4=0;i4<refRows.length;i4++){ if (refRows[i4].category === cat){ return refRows[i4].value || 0; } } return 0; }
    function findRange(cat){ for (var j4=0;j4<refRows.length;j4++){ if (refRows[j4].category === cat){ return refRows[j4].value_range || null; } } return null; }
    var edMean = findVal("ed_treat_and_release_us") || 750;
    var rrh = findVal("rapid_rehousing_us") || 0;
    var psh = findVal("permanent_supportive_housing_us") || 0;
    var jailRange = findRange("jail_indiana") || [0,0];
    var jailMid = (jailRange[0]+jailRange[1])/2;

    var edVisits = qs("#edVisits");
    var jailNights = qs("#jailNights");
    var cmpCtx = qs("#chartCompare");
    var cmpChart = null;

    function updateCompare(){
      var v = Number(edVisits.value);
      var n = Number(jailNights.value);
      qs("#edVisitsCount").textContent = v;
      qs("#jailNightsCount").textContent = n;

      var edTotal = v * edMean;
      var jailTotalMid = n * jailMid;
      var jailTotalLow = n * jailRange[0];
      var jailTotalHigh = n * jailRange[1];

      qs("#edTotal").textContent = fmtUSD(edTotal);
      qs("#jailTotal").textContent = fmtUSD(jailTotalMid);
      qs("#jailRangeNote").textContent = (jailRange[0] && jailRange[1]) ? " (range "+fmtUSD(jailTotalLow)+"–"+fmtUSD(jailTotalHigh)+")" : "";

      var labels = ["ED total", "Jail total", "Rapid Rehousing (annual)", "PSH (annual)"];
      var data = [edTotal, jailTotalMid, rrh, psh];

      if (cmpChart){ cmpChart.destroy(); }
      cmpChart = new Chart(cmpCtx, {
        type:"bar",
        data:{ labels: labels, datasets:[{ label:"USD", data: data }]},
        options:{ plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:function(c){ return fmtUSD(c.parsed.y); }}}},
                  scales:{ y:{ beginAtZero:true, ticks:{ callback:function(v){ return fmtUSD(v); }}}} }
      });
    }
    edVisits.addEventListener("input", updateCompare);
    jailNights.addEventListener("input", updateCompare);
    updateCompare();
    qs("#compareSource").innerHTML = provenanceLinks((function(){
      var arr=[]; for (var i5=0;i5<refRows.length;i5++){ var cat=refRows[i5].category;
        if (cat==="ed_treat_and_release_us" || cat==="rapid_rehousing_us" || cat==="permanent_supportive_housing_us" || cat==="jail_indiana"){ arr.push(refRows[i5]); }
      } return arr; })());

    // Findings
    var fRows = (finds && finds.data) ? finds.data : [];
    var fWrap = qs("#findings");
    for (var f=0; f<fRows.length; f++){
      var row = fRows[f];
      var div = document.createElement("div"); div.className="row"; div.style.margin="6px 0"; div.textContent = "• " + row.text;
      var src = document.createElement("div"); src.className="small"; src.innerHTML = provenanceLinks([row]);
      var box = document.createElement("div"); box.appendChild(div); box.appendChild(src);
      fWrap.appendChild(box);
    }

    // Status
    var status = qs("#status");
    function countPending(rows){ var c=0; for (var i6=0;i6<rows.length;i6++){ if (rows[i6].pending){ c++; } } return c; }
    var cards = [
      { title:"Shelter costs", total: scRows.length, pending: countPending(scRows), src: provenanceLinks(scRows) },
      { title:"Contracts", total: cRows.length, pending: 0, src: provenanceLinks(cRows) },
      { title:"Hospital ED 99284", total: edRows.length, pending: countPending(edRows), src: provenanceLinks(edRows) },
      { title:"Reference costs", total: refRows.length, pending: 0, src: provenanceLinks(refRows) }
    ];
    var html = '<div class="grid">';
    for (var cc=0; cc<cards.length; cc++){
      var c = cards[cc];
      html += '<div class="card span-3" style="padding:12px"><h3>'+c.title+'</h3><div class="row"><div><strong>'+c.total+
              '</strong> rows</div>' + (c.pending ? '<div class="pending">'+c.pending+' pending</div>' : '') +
              '</div><div class="small" style="margin-top:6px">'+c.src+'</div></div>';
    }
    html += '</div>'; status.innerHTML = html;
  }).catch(function(err){
    console.error(err);
    qs("#app").innerHTML = '<div class="card"><h2>Load error</h2><p class="small">'+String(err)+'</p></div>';
  });
}
init();
</script>
</body>
</html>