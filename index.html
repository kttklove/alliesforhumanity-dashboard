<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Business of Homelessness — Marion County</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root { --bg:#fff; --text:#111; --muted:#565; --accent:#0e7c86; --card:#f7f7f9; --shadow:0 2px 10px rgba(0,0,0,.08); --radius:16px; }
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Noto Sans,sans-serif;line-height:1.45}
    .wrap{max-width:1060px;margin:0 auto;padding:20px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .span-12{grid-column:span 12}.span-8{grid-column:span 8}.span-6{grid-column:span 6}.span-4{grid-column:span 4}.span-3{grid-column:span 3}
    @media (max-width:920px){.span-8,.span-6{grid-column:span 12}.span-4,.span-3{grid-column:span 6}}
    @media (max-width:640px){.span-4,.span-3{grid-column:span 12}}
    h2{margin:0 0 10px;font-size:20px} .source{font-size:12px;color:var(--muted);margin-top:10px}
    .pending{display:inline-block;padding:2px 8px;border-radius:999px;background:#fff8e1;color:#8a5a00;font-size:12px;border:1px solid #ffda6a}
    .pill{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;background:#eef8f9;color:var(--accent);border:1px solid #c8ecef}
    .row{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
    .stat{font-size:28px;font-weight:600}
    .small{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:#eaeaea;margin:10px 0 14px}
    .btnbar{display:flex;gap:8px;flex-wrap:wrap}
    button.tab{background:#fff;border:1px solid #e6e6e6;border-radius:999px;padding:6px 10px;cursor:pointer;font-size:12px}
    button.tab.active{background:#eef8f9;border-color:#c8ecef;color:var(--accent)}
    .calc input[type=range]{width:100%}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Business of Homelessness – Marion County</h1>
    <p class="small">Static dashboard generated from JSON endpoints.</p>
  </header>
  <main class="wrap" id="app">
    <section class="grid">
      <div class="card span-8" id="shelter-costs-card">
        <h2>Cost per night of shelter (USD)</h2>
        <canvas id="chartShelterCosts"></canvas>
        <div id="shelterCostsPending" class="small"></div>
        <div class="source" id="shelterCostsSource"></div>
      </div>
      <div class="card span-4">
        <h2>Contracts and funding</h2>
        <div id="contractsStats" class="row"></div>
        <div class="divider"></div>
        <canvas id="chartContracts"></canvas>
        <div class="source" id="contractsSource"></div>
      </div>
      <div class="card span-6">
        <h2>ED visit facility fee – CPT 99284 (USD)</h2>
        <div class="btnbar" id="edTabs"></div>
        <canvas id="chartED"></canvas>
        <div id="edPending" class="small"></div>
        <div class="source" id="edSource"></div>
      </div>
      <div class="card span-6 calc" id="calcCard">
        <h2>What-if: redirect crisis costs into housing</h2>
        <label for="visitsSlider">ED treat-and-release visits per year</label>
        <input id="visitsSlider" type="range" min="0" max="24" step="1" value="6" />
        <div class="row">
          <div><span class="stat" id="visitsCount">6</span> <span class="small">visits</span></div>
          <div><span class="stat" id="edTotal">$0</span> <span class="small">ED cost (national mean, 2021)</span></div>
        </div>
        <div class="divider"></div>
        <div class="row">
          <div><span class="stat" id="rrhAnnual">$0</span> <span class="small">Rapid Rehousing annual</span></div>
          <div><span class="stat" id="pshAnnual">$0</span> <span class="small">PSH annual</span></div>
        </div>
        <div class="source" id="calcSource"></div>
      </div>
      <div class="card span-12">
        <h2>Findings from the literature</h2>
        <div id="findings"></div>
      </div>
      <div class="card span-12">
        <h2>Data status</h2>
        <div id="status"></div>
      </div>
    </section>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script>
    function EP(p){ return new URL(p, window.location.href).toString(); }

    var ENDPOINTS = {
      shelter_costs: EP("data/endpoints/v1/marion/shelter_costs.json"),
      shelter_contracts: EP("data/endpoints/v1/marion/shelter_contracts.json"),
      hospital_er: EP("data/endpoints/v1/marion/hospital_er_99284.json"),
      ref_costs: EP("data/endpoints/v1/reference/costs.json"),
      findings: EP("data/endpoints/v1/reference/findings.json")
    };

    function fmtUSD(n){ return (n==null) ? "—" : n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0}); }
    function qs(sel){ return document.querySelector(sel); }

    async function loadJSON(path){
      var res = await fetch(path, {cache:"no-store"});
      if(!res.ok){ throw new Error("Failed to load "+path); }
      return res.json();
    }

    function provenanceLinks(rows){
      var urls = [];
      (rows||[]).forEach(function(r){
        if(!r) return;
        var prov = r.provenance;
        if(Array.isArray(prov)){
          for (var i=0;i<prov.length;i++){
            var p = prov[i];
            if(p && p.url && urls.indexOf(p.url)===-1){ urls.push(p.url); }
          }
        } else if(prov && prov.url){
          if(urls.indexOf(prov.url)===-1){ urls.push(prov.url); }
        }
      });
      var out = "";
      for (var j=0;j<urls.length;j++){
        if (j>0) out += " · ";
        out += '<a href="'+urls[j]+'" target="_blank" rel="noopener">source</a>';
      }
      return out;
    }

    async function init(){
      var shelterCosts, contracts, ed, refs, finds;
      try{
        var all = await Promise.all([
          loadJSON(ENDPOINTS.shelter_costs),
          loadJSON(ENDPOINTS.shelter_contracts),
          loadJSON(ENDPOINTS.hospital_er),
          loadJSON(ENDPOINTS.ref_costs),
          loadJSON(ENDPOINTS.findings)
        ]);
        shelterCosts = all[0]; contracts = all[1]; ed = all[2]; refs = all[3]; finds = all[4];
      } catch(e){
        console.error(e);
        qs("#app").innerHTML = '<div class="card"><h2>Load error</h2><p class="small">'+String(e)+'</p></div>';
        return;
      }

      // Shelter per-diem
      var scRows = (shelterCosts && shelterCosts.data) ? shelterCosts.data : [];
      var scKnown = scRows.filter(function(r){ return typeof r.value === "number"; });
      var scPending = scRows.filter(function(r){ return r.pending || r.value == null; });
      var scCtx = qs("#chartShelterCosts");
      if (scKnown.length){
        new Chart(scCtx, {
          type: "bar",
          data: {
            labels: scKnown.map(function(r){return r.provider;}),
            datasets: [{ label: "USD per person per night", data: scKnown.map(function(r){return r.value;}) }]
          },
          options: {
            plugins: {
              legend: { display:false },
              tooltip: { callbacks: { label: function(c){ return fmtUSD(c.parsed.y); } } }
            },
            scales: { y: { beginAtZero:true, ticks: { callback: function(v){ return fmtUSD(v); } } } }
          }
        });
      } else {
        scCtx.replaceWith(document.createTextNode("No published per-diem values yet."));
      }
      if (scPending.length){
        var pills = scPending.map(function(r){ return 'Pending: <span class="pill">'+r.provider+'</span>'; }).join(" ");
        qs("#shelterCostsPending").innerHTML = pills;
      }
      qs("#shelterCostsSource").innerHTML = provenanceLinks(scRows);

      // Contracts
      var cRows = (contracts && contracts.data) ? contracts.data : [];
      var cCtx = qs("#chartContracts");
      var amounts = cRows.map(function(r){ return r.amount_usd || 0; });
      new Chart(cCtx, {
        type:"bar",
        data:{ labels: cRows.map(function(r){ return r.program; }), datasets:[{ label:"Amount (USD)", data: amounts }]},
        options:{
          indexAxis:"y",
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:function(c){ return fmtUSD(c.parsed.x); }}}},
          scales:{ x:{ ticks:{ callback:function(v){ return fmtUSD(v); }}}}
        }
      });
      var total = amounts.reduce(function(a,b){return a+b;},0);
      qs("#contractsStats").innerHTML = '<div class="stat">'+fmtUSD(total)+'</div><div class="small">Total funding in listed programs</div>';
      qs("#contractsSource").innerHTML = provenanceLinks(cRows);

      // ED rates
      var edRows = (ed && ed.data) ? ed.data : [];
      var hospitals = [];
      for (var h=0; h<edRows.length; h++){
        var lab = (edRows[h].system||"") + " — " + (edRows[h].facility||"");
        if (hospitals.indexOf(lab)===-1) hospitals.push(lab);
      }
      var tabWrap = qs("#edTabs");
      var active = hospitals[0] || null;

      function renderED(){
        var el = qs("#chartED");
        var ctx = el.getContext("2d");
        ctx.clearRect(0,0,el.width, el.height);
        var rows = edRows.filter(function(r){ return (r.system||"")+" — "+(r.facility||"") === active; });
        var known = rows.filter(function(r){ return typeof r.rate_usd === "number"; });
        var payers = ["self_pay_cash","medicaid","commercial_example"];
        var data = payers.map(function(p){
          var row = rows.find(function(r){ return r.payer_type === p; });
          return row ? row.rate_usd : null;
        });
        if (known.length){
          new Chart(el, {
            type:"bar",
            data:{ labels: payers.map(function(p){ return p.replace("_"," "); }), datasets:[{ label:"USD per visit", data: data }]},
            options:{
              plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:function(c){ return fmtUSD(c.parsed.y); }}}},
              scales:{ y:{ beginAtZero:true, ticks:{ callback:function(v){ return fmtUSD(v); }}}}
            }
          });
          qs("#edPending").textContent = "";
        } else {
          new Chart(el, {
            type:"bar",
            data:{ labels:["No published rates available"], datasets:[{ data:[0] }]},
            options:{ plugins:{ legend:{ display:false }, tooltip:{ enabled:false }}, scales:{ y:{ display:false }, x:{ display:false }}}
          });
          qs("#edPending").innerHTML = '<span class="pending">Local rate extraction pending</span> · National mean (2021): <strong>$750</strong>';
        }
        qs("#edSource").innerHTML = provenanceLinks(rows);
      }

      if (hospitals.length){
        for (var i=0;i<hospitals.length;i++){
          (function(hname, idx){
            var b = document.createElement("button");
            b.className = "tab" + (idx===0 ? " active" : "");
            b.textContent = hname;
            b.onclick = function(){
              var bs = tabWrap.querySelectorAll("button.tab");
              for (var k=0;k<bs.length;k++){ bs[k].classList.remove("active"); }
              b.classList.add("active");
              active = hname;
              renderED();
            };
            tabWrap.appendChild(b);
          })(hospitals[i], i);
        }
      } else {
        tabWrap.innerHTML = '<span class="small">No hospitals found in dataset.</span>';
      }
      renderED();

      // What-if calculator
      var refRows = (refs && refs.data) ? refs.data : [];
      function pick(category){
        for (var i=0;i<refRows.length;i++){
          if (refRows[i].category === category){
            return refRows[i].value || 0;
          }
        }
        return 0;
      }
      var edMean = pick("ed_treat_and_release_us") || 750;
      var rrh = pick("rapid_rehousing_us") || 0;
      var psh = pick("permanent_supportive_housing_us") || 0;

      var slider = qs("#visitsSlider");
      function recalc(){
        var n = Number(slider.value);
        qs("#visitsCount").textContent = n;
        qs("#edTotal").textContent = fmtUSD(n * edMean);
        qs("#rrhAnnual").textContent = fmtUSD(rrh);
        qs("#pshAnnual").textContent = fmtUSD(psh);
      }
      slider.addEventListener("input", recalc);
      recalc();
      var calcSources = [];
      for (var j=0;j<refRows.length;j++){
        var cat = refRows[j].category;
        if (cat==="ed_treat_and_release_us" || cat==="rapid_rehousing_us" || cat==="permanent_supportive_housing_us"){
          calcSources.push(refRows[j]);
        }
      }
      qs("#calcSource").innerHTML = provenanceLinks(calcSources);

      // Findings
      var fRows = (finds && finds.data) ? finds.data : [];
      var fWrap = qs("#findings");
      for (var m=0;m<fRows.length;m++){
        var row = fRows[m];
        var div = document.createElement("div");
        div.className = "row";
        div.style.margin = "6px 0";
        div.textContent = "• " + row.text;
        var src = document.createElement("div");
        src.className = "source";
        src.innerHTML = provenanceLinks([row]);
        var box = document.createElement("div");
        box.appendChild(div); box.appendChild(src);
        fWrap.appendChild(box);
      }

      // Status
      var status = qs("#status");
      function countPending(rows){ var c=0; for (var q=0;q<rows.length;q++){ if (rows[q].pending){ c++; } } return c; }
      var cards = [
        { title:"Shelter costs", total: scRows.length, pending: countPending(scRows), src: provenanceLinks(scRows) },
        { title:"Contracts", total: cRows.length, pending: 0, src: provenanceLinks(cRows) },
        { title:"Hospital ED 99284", total: edRows.length, pending: countPending(edRows), src: provenanceLinks(edRows) },
        { title:"Reference costs", total: refRows.length, pending: 0, src: provenanceLinks(refRows) }
      ];
      var statusHTML = '<div class="grid">';
      for (var s=0;s<cards.length;s++){
        var c = cards[s];
        statusHTML += '<div class="card span-3" style="padding:12px">';
        statusHTML += '<h3>'+c.title+'</h3>';
        statusHTML += '<div class="row"><div><strong>'+c.total+'</strong> rows</div>';
        if (c.pending){ statusHTML += '<div class="pending">'+c.pending+' pending</div>'; }
        statusHTML += '</div><div class="source" style="margin-top:6px">'+c.src+'</div></div>';
      }
      statusHTML += '</div>';
      status.innerHTML = statusHTML;
    }

    init();
  </script>
</body>
</html>
